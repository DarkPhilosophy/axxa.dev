<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AXXA SQL Cluster Status</title>
  <style>
    @font-face { font-family: "Quicksand"; font-style: normal; font-weight: 300; src: url(https://crearts-community.github.io/Assets/fonts/quicksand/quicksand-300.woff2) format("woff2"); }
    @font-face { font-family: "Quicksand"; font-style: normal; font-weight: 400; src: url(https://crearts-community.github.io/Assets/fonts/quicksand/quicksand-400.woff2) format("woff2"); }
    @font-face { font-family: "Quicksand"; font-style: normal; font-weight: 500; src: url(https://crearts-community.github.io/Assets/fonts/quicksand/quicksand-500.woff2) format("woff2"); }
    @font-face { font-family: "Quicksand"; font-style: normal; font-weight: 600; src: url(https://crearts-community.github.io/Assets/fonts/quicksand/quicksand-600.woff2) format("woff2"); }
    @font-face { font-family: "Quicksand"; font-style: normal; font-weight: 700; src: url(https://crearts-community.github.io/Assets/fonts/quicksand/quicksand-700.woff2) format("woff2"); }

    :root{--bg:#000;--panel:#06090f;--line:#162033;--text:#eaf1ff;--muted:#b6c7ef;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:'Quicksand',sans-serif;background:var(--bg);color:var(--text)}
    .wrap{width:100%;max-width:none;padding:18px}
    h1{margin:0 0 8px} .sub{color:var(--muted);margin-top:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .healthy{background:rgba(34,197,94,.18);color:#86efac}.degraded{background:rgba(245,158,11,.18);color:#fcd34d}.danger{background:rgba(239,68,68,.18);color:#fca5a5}
    code{font-family:'Consolas',monospace;background:#090d14;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
    a{color:#93c5fd}
    .chart-wrap{margin-top:12px}
    canvas{width:100%;height:220px;background:#090d14;border:1px solid var(--line);border-radius:10px}
    .legend{font-size:13px;color:var(--muted);margin-top:8px}
    .reason{margin-top:8px;color:#fde68a}
    .outages{margin-top:12px}
    .outages-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .outages-wrap{max-height:360px;overflow:auto;margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#090d14}
    .event{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px;background:#0c1320}
    .event:last-child{margin-bottom:0}
    .event h3{margin:0 0 6px 0;font-size:16px}
    .event p{margin:4px 0;color:var(--muted)}
    .samples{margin-top:6px;padding-left:16px;color:#dbe7ff}
    .btn{border:1px solid var(--line);background:#0b1220;color:#dbe7ff;border-radius:8px;padding:8px 12px;cursor:pointer}
  </style>
  <link rel="icon" type="image/svg+xml" href="https://sql.axxa.dev/favicon.svg?v=6" />
</head>
<body>
  <main class="wrap">
    <h1>AXXA SQL Cluster Status</h1>
    <p class="sub">Live source: <code><a id="sourceLink" href="https://sql.axxa.dev/status.json" target="_blank" rel="noopener noreferrer">https://sql.axxa.dev/status.json</a></code></p>
    <section class="grid">
      <article class="card">
        <h2>Overall</h2>
        <div id="overall" class="badge">Loading</div>
        <p id="primary">Primary: -</p>
        <p id="updated">Updated: -</p>
        <p id="reason" class="reason">Reason: -</p>
      </article>
      <article class="card">
        <h2>ATVPS</h2>
        <p id="a_country"></p><p id="a_mode"></p><p id="a_sqld"></p><p id="a_agent"></p><p id="a_port"></p><p id="a_ns"></p><p id="a_uptime"></p>
      </article>
      <article class="card">
        <h2>GoogleVPS</h2>
        <p id="c_country"></p><p id="c_reach"></p><p id="c_mode"></p><p id="c_sqld"></p><p id="c_agent"></p><p id="c_port"></p><p id="c_ns"></p><p id="c_uptime"></p>
      </article>
    </section>

    <section class="card chart-wrap">
      <h2>Health Timeline</h2>
      <canvas id="healthChart" width="980" height="220"></canvas>
      <div class="legend">Green = healthy, Yellow = degraded, Red = danger. Line has live pulse animation.</div>
    </section>

    <section class="card outages">
      <div class="outages-head">
        <h2>Outage History</h2>
        <button id="loadMore" class="btn" type="button">Load older</button>
      </div>
      <div class="legend" id="outageMeta">Loadingâ€¦</div>
      <div id="outageList" class="outages-wrap"></div>
    </section>
  </main>
  <script>
    const STATUS_URL='https://sql.axxa.dev/status.json';
    const HISTORY_URL='https://sql.axxa.dev/history.json';
    const OUTAGES_URL='https://sql.axxa.dev/outages.json';
    const KEY_STATUS='axxa_sql_status_cache_v1';
    const KEY_HISTORY='axxa_sql_history_cache_v1';
    const KEY_OUTAGES='axxa_sql_outages_cache_v1';

    let chartPoints=[];
    let phase=0;
    let outageCursor=0;
    let outageEvents=[];

    function fmt(sec){sec=Number(sec||0);const d=Math.floor(sec/86400),h=Math.floor((sec%86400)/3600),m=Math.floor((sec%3600)/60);return `${d}d ${h}h ${m}m`}
    function dt(ts){try{return new Date(ts*1000).toISOString().replace('T',' ').replace('Z',' UTC')}catch(_){return '-'}}
    function safeJson(v){try{return JSON.parse(v)}catch(_){return null}}

    async function fetchJsonWithCache(url,key){
      try{
        const r=await fetch(url,{cache:'no-store'});
        if(!r.ok) throw new Error('http '+r.status);
        const j=await r.json();
        localStorage.setItem(key, JSON.stringify(j));
        return j;
      }catch(_){
        const cached=safeJson(localStorage.getItem(key));
        if(cached) return cached;
        throw _;
      }
    }

    async function loadStatus(){
      try{
        const j=await fetchJsonWithCache(STATUS_URL, KEY_STATUS);
        const a=j.nodes.ATVPS, c=j.nodes.GoogleVPS || j.nodes.CloudVPS;
        const b=document.getElementById('overall');
        b.textContent=String(j.overall).toUpperCase();b.className='badge '+j.overall;
        document.getElementById('primary').textContent='Primary: '+j.primary_node;
        document.getElementById('updated').textContent='Updated: '+j.updated_at_utc;
        document.getElementById('reason').textContent='Reason: '+(j.health_reason||'n/a');
        document.getElementById('a_country').textContent='Country: '+(a.country||'Unknown');
        document.getElementById('a_mode').textContent='Mode: '+a.mode;
        document.getElementById('a_sqld').textContent='sqld: '+a.sqld_active;
        document.getElementById('a_agent').textContent='agent: '+a.agent_active;
        document.getElementById('a_port').textContent='19001: '+(a.primary_port_19001?'open (primary)':'closed');
        document.getElementById('a_ns').textContent='Namespaces: '+a.namespaces;
        document.getElementById('a_uptime').textContent='Uptime: '+fmt(a.sqld_uptime_sec);
        document.getElementById('c_country').textContent='Country: '+(c.country||'Unknown');
        document.getElementById('c_reach').textContent='Reachable: '+c.reachable;
        document.getElementById('c_mode').textContent='Mode: '+c.mode;
        document.getElementById('c_sqld').textContent='sqld: '+c.sqld_active;
        document.getElementById('c_agent').textContent='agent: '+c.agent_active;
        document.getElementById('c_port').textContent='19001: '+(c.primary_port_19001?'open (primary)':'closed');
        document.getElementById('c_ns').textContent='Namespaces: '+c.namespaces;
        document.getElementById('c_uptime').textContent='Uptime: '+fmt(c.sqld_uptime_sec);
      }catch(e){const b=document.getElementById('overall');b.textContent='UNAVAILABLE';b.className='badge danger';document.getElementById('reason').textContent='Reason: status feed unavailable';}
    }

    async function loadHistory(){
      try{
        const h=await fetchJsonWithCache(HISTORY_URL, KEY_HISTORY);
        chartPoints=(h.points||[]).slice(-180);
      }catch(_){ chartPoints=[]; }
    }

    function drawChart(){
      const c=document.getElementById('healthChart');
      if(!c) return;
      const ctx=c.getContext('2d');
      const w=c.width,hg=c.height,p=20;
      const map={healthy:2,degraded:1,danger:0},colors={healthy:'#22c55e',degraded:'#f59e0b',danger:'#ef4444'};
      ctx.clearRect(0,0,w,hg);

      ctx.strokeStyle='#1d4ed8';ctx.lineWidth=1;
      for(let i=0;i<3;i++){const y=p+((hg-2*p)/2)*i;ctx.beginPath();ctx.moveTo(p,y);ctx.lineTo(w-p,y);ctx.stroke();}

      if(!chartPoints.length){ctx.fillStyle='#b6c7ef';ctx.fillText('No history yet',12,24);return;}

      for(let i=1;i<chartPoints.length;i++){
        const p0=chartPoints[i-1],p1=chartPoints[i];
        const x0=p+((w-2*p)*(i-1)/(chartPoints.length-1));
        const x1=p+((w-2*p)*i/(chartPoints.length-1));
        const y0=p+((hg-2*p)*(2-(map[p0.overall]??1))/2) + Math.sin((phase+x0)/30)*1.8;
        const y1=p+((hg-2*p)*(2-(map[p1.overall]??1))/2) + Math.sin((phase+x1)/30)*1.8;
        ctx.strokeStyle=colors[p1.overall]||'#f59e0b';
        ctx.lineWidth=2.2;
        ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);ctx.stroke();
      }

      const last=chartPoints[chartPoints.length-1];
      const lx=p+((w-2*p)*(chartPoints.length-1)/(chartPoints.length-1));
      const ly=p+((hg-2*p)*(2-(map[last.overall]??1))/2) + Math.sin((phase+lx)/30)*1.8;
      ctx.beginPath();ctx.arc(lx,ly,4,0,Math.PI*2);ctx.fillStyle='#93c5fd';ctx.fill();
      phase += 1.2;
      requestAnimationFrame(drawChart);
    }

    function renderOutages(reset=false){
      const list=document.getElementById('outageList');
      const meta=document.getElementById('outageMeta');
      if(reset){list.innerHTML='';outageCursor=0;}
      const batch=5;
      const next=Math.min(outageCursor+batch, outageEvents.length);
      for(let i=outageCursor;i<next;i++){
        const ev=outageEvents[i];
        const div=document.createElement('article');
        div.className='event';
        const sev=(ev.severity_last||'degraded').toUpperCase();
        const sm=(ev.samples||[]).slice(-3).map(s=>`<li>${dt(s.ts)} - ${s.reason}</li>`).join('');
        div.innerHTML=`<h3>${sev} outage</h3><p><strong>Source node:</strong> ${ev.source_node||'unknown'}</p><p><strong>Event ID:</strong> <code>${ev.fingerprint||'n/a'}</code></p><p><strong>Start:</strong> ${ev.start_utc||dt(ev.start_ts)}</p><p><strong>End:</strong> ${ev.end_utc||'OPEN'}</p><p><strong>Duration:</strong> ${fmt(ev.duration_sec||0)}</p><p><strong>Last reason:</strong> ${ev.reason_last||'n/a'}</p>${sm?`<ul class="samples">${sm}</ul>`:''}`;
        list.appendChild(div);
      }
      outageCursor=next;

      while(list.children.length>25){ list.removeChild(list.firstChild); }

      if(!outageEvents.length){list.innerHTML='<div class="legend">No outage events yet.</div>';}
      const loaded=list.children.length;
      meta.textContent=`Showing ${loaded} cards (windowed), total events: ${outageEvents.length}. Loaded cursor: ${outageCursor}/${outageEvents.length}`;
      document.getElementById('loadMore').disabled = outageCursor >= outageEvents.length;
    }

    async function loadOutages(){
      try{
        const o=await fetchJsonWithCache(OUTAGES_URL, KEY_OUTAGES);
        const closed=(o.events||[]).slice().reverse();
        const open=o.open ? [{
          start_ts:o.open.start_ts,
          start_utc:o.open.start_utc,
          end_utc:'OPEN',
          duration_sec: Math.max(0, Math.floor(Date.now()/1000)-Number(o.open.start_ts||0)),
          reason_last:o.open.reason,
          severity_last:o.open.last_overall||'degraded',
          samples:o.open.samples||[]
        }] : [];
        outageEvents=open.concat(closed);
        renderOutages(true);
      }catch(_){
        outageEvents=[];
        renderOutages(true);
      }
    }

    const sourceLink=document.getElementById('sourceLink');
    if(sourceLink){sourceLink.addEventListener('click',function(e){const selected=window.getSelection?window.getSelection().toString():'';if(selected&&selected.length>0){e.preventDefault();}})}

    document.getElementById('loadMore').addEventListener('click',()=>renderOutages(false));
    document.getElementById('outageList').addEventListener('scroll',(e)=>{
      const el=e.currentTarget;
      if(el.scrollTop + el.clientHeight >= el.scrollHeight - 24) renderOutages(false);
    });

    (async()=>{
      await loadStatus();
      await loadHistory();
      await loadOutages();
      requestAnimationFrame(drawChart);
      setInterval(loadStatus,10000);
      setInterval(loadHistory,10000);
      setInterval(loadOutages,30000);
    })();
  </script>
</body>
</html>
