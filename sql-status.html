<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AXXA PostgreSQL Operations</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#05070c;--panel:#0f1522;--panel2:#131e33;--line:#243658;--text:#eef4ff;--muted:#95a9cd;--ok:#1fbe6b;--warn:#eea22c;--bad:#e24a5d;--accent:#4dc2ff}
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:"Space Grotesk",sans-serif;background:radial-gradient(1200px 520px at 10% -15%,#2f89ff33 0%,transparent 55%),radial-gradient(900px 420px at 110% 0%,#11b37a24 0%,transparent 45%),var(--bg);min-height:100vh}
    .container{max-width:1380px;margin:0 auto;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    h1{margin:0;font-size:30px;line-height:1.1}.subtitle{margin-top:8px;color:var(--muted);font-size:14px}.mono{font-family:"IBM Plex Mono",ui-monospace,monospace}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:#1a2a47;border:1px solid #3f5c8d;color:#dfeaff;border-radius:12px;padding:9px 14px;font-weight:600;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 14px;border:1px solid #ffffff20;font-weight:700;font-size:12px;letter-spacing:.04em}
    .dot{width:9px;height:9px;border-radius:999px;display:inline-block}
    .ok{background:#0f2f1f;color:#a8f3cb}.ok .dot{background:var(--ok)}
    .warn{background:#3a2a0f;color:#ffe0ae}.warn .dot{background:var(--warn)}
    .bad{background:#3d1620;color:#ffc2cb}.bad .dot{background:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:14px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:inset 0 1px 0 #ffffff0d}
    .k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;font-weight:600}
    .v{margin-top:7px;font-size:30px;font-weight:700;line-height:1.1}.v.small{font-size:17px}
    .span-3{grid-column:span 3}.span-4{grid-column:span 4}.span-6{grid-column:span 6}.span-8{grid-column:span 8}.span-12{grid-column:span 12}
    .reason{margin-top:8px;padding:10px;border:1px solid #294065;border-radius:12px;background:#0b1728;color:#cfe0ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid #3a5788;border-radius:999px;background:#0d1a30;color:#d6e4ff;font-size:12px}
    .node-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;margin-top:10px}
    .node-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .node-title{font-size:20px;font-weight:700}
    .node-meta{font-size:12px;color:var(--muted)}
    .metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:10px}
    .metric{padding:9px;border:1px solid #2a4066;border-radius:10px;background:#0d1a2e}
    .metric .mkey{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .metric .mval{font-size:16px;font-weight:700;margin-top:4px}
    .mono-box{margin-top:10px;background:#0a1426;border:1px solid #263a60;border-radius:10px;padding:10px;font-size:12px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
    .mismatch-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px;margin-top:10px}
    .mismatch-item{border:1px solid #2a4066;border-radius:10px;padding:10px;background:#0d1a2e}
    canvas{width:100%;height:230px;border:1px solid var(--line);border-radius:12px;background:#0b1424;display:block}
    .legend{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px}.chip i{display:inline-block;width:10px;height:10px;border-radius:999px}
    .input{background:#0f1c33;color:#dce9ff;border:1px solid #324c77;border-radius:10px;padding:7px 10px;font:inherit;font-size:13px}
    .timeline-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .incident-scroll{height:460px;overflow:auto;border:1px solid #2b4068;border-radius:12px;background:#0b1629}
    .incident-row{height:126px;padding:10px 12px;border-bottom:1px solid #294167}
    .incident-row:last-child{border-bottom:none}
    .incident-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .footer{margin-top:12px;color:var(--muted);font-size:12px}
    @media (max-width:1000px){.span-3,.span-4,.span-6,.span-8{grid-column:span 12}h1{font-size:24px}.v{font-size:24px}.incident-scroll{height:380px}}
  </style>
</head>
<body>
  <main class="container">
    <header class="topbar">
      <div>
        <h1>AXXA PostgreSQL Operations</h1>
        <div class="subtitle">Live from <a href="/status.json" target="_blank" style="color:var(--accent)">/status.json</a></div>
      </div>
      <div class="actions">
        <span id="overallBadge" class="badge warn"><span class="dot"></span>LOADING</span>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </header>

    <section class="grid">
      <article class="card span-3"><div class="k">Primary Node</div><div id="primary" class="v mono">-</div></article>
      <article class="card span-3"><div class="k">Cluster Mode</div><div id="mode" class="v mono">-</div></article>
      <article class="card span-3"><div class="k">Backend</div><div id="backend" class="v small mono">-</div></article>
      <article class="card span-3"><div class="k">Reachable Nodes</div><div id="reach" class="v mono">-</div></article>

      <article class="card span-4"><div class="k">Namespace Union</div><div id="namespaceUnionCount" class="v mono">-</div></article>
      <article class="card span-4"><div class="k">Namespace Mismatch</div><div id="namespaceMismatchFlag" class="v small mono">-</div></article>
      <article class="card span-4"><div class="k">Last Update UTC</div><div id="updated" class="v small mono">-</div></article>

      <article class="card span-12"><div class="k">Health Reason</div><div id="reason" class="reason mono">-</div></article>

      <article class="card span-12">
        <div class="k">Nodes (Cards)</div>
        <div id="nodeCards" class="node-grid"></div>
      </article>

      <article class="card span-12">
        <div class="k">Namespace Mismatch Details</div>
        <div id="nsMismatch" class="mismatch-list"></div>
      </article>

      <article class="card span-12">
        <div class="k">Content Mismatch (cafea)</div>
        <div id="contentMismatch" class="mismatch-list"></div>
      </article>

      <article class="card span-8">
        <div class="k">Health Timeline</div>
        <div class="timeline-controls">
          <label class="mono" for="rangeValue">Last</label>
          <input id="rangeValue" class="input mono" type="number" min="1" value="120" style="width:90px" />
          <select id="rangeUnit" class="input mono">
            <option value="minute">minutes</option>
            <option value="hour" selected>hours</option>
            <option value="day">days</option>
          </select>
          <button class="btn small" data-preset="30m">30m</button>
          <button class="btn small" data-preset="2h">2h</button>
          <button class="btn small" data-preset="24h">24h</button>
          <button class="btn small" data-preset="7d">7d</button>
        </div>
        <canvas id="chart" width="940" height="230"></canvas>
        <div class="legend">
          <span class="chip"><i style="background:var(--ok)"></i> healthy</span>
          <span class="chip"><i style="background:var(--warn)"></i> degraded</span>
          <span class="chip"><i style="background:var(--bad)"></i> danger</span>
        </div>
      </article>

      <article class="card span-4">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div class="k">Recent Incidents</div>
          <div id="incidentMeta" class="mono" style="font-size:11px;color:var(--muted)">-</div>
        </div>
        <div id="incidentScroll" class="incident-scroll">
          <div id="incidentTopSpacer"></div>
          <div id="incidentRows"></div>
          <div id="incidentBottomSpacer"></div>
        </div>
      </article>
    </section>

    <div class="footer mono">auto-refresh every 10s</div>
  </main>

<script>
const STATUS='/status.json', HISTORY='/history.json', OUTAGES='/outages.json';
const CACHE={s:'ax_pg_s1',h:'ax_pg_h1',o:'ax_pg_o1'};
let pointsAll=[];
let points=[];
let incidentsAll=[];
let phase=0;
let fromTs=0;
let toTs=0;
const rowH=126;
const overscan=4;

const el=id=>document.getElementById(id);
const asJson=x=>{try{return JSON.parse(x)}catch{return null}};
const nowTs=()=>Math.floor(Date.now()/1000);
const uptime=s=>{s=Number(s||0);const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60);return `${d}d ${h}h ${m}m`;};

function getRangeSec(){
  const v=Math.max(1,Number(el('rangeValue').value||1));
  const u=el('rangeUnit').value;
  if(u==='minute') return v*60;
  if(u==='hour') return v*3600;
  return v*86400;
}

function setPreset(p){
  const m=p.match(/^(\d+)([mhd])$/);
  if(!m) return;
  const num=Number(m[1]);
  const unit=m[2]==='m'?'minute':m[2]==='h'?'hour':'day';
  el('rangeValue').value=String(num);
  el('rangeUnit').value=unit;
  applyTimeFilter();
}

async function getJson(url,key){
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error(`http ${r.status}`);
    const data=await r.json();
    localStorage.setItem(key,JSON.stringify(data));
    return data;
  }catch(e){
    const cached=asJson(localStorage.getItem(key));
    if(cached) return cached;
    throw e;
  }
}

function setBadge(state){
  const b=el('overallBadge');
  b.className='badge '+(state==='healthy'?'ok':state==='danger'?'bad':'warn');
  b.innerHTML=`<span class="dot"></span>${String(state||'unknown').toUpperCase()}`;
}

function drawChart(){
  const c=el('chart'); if(!c) return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height,p=18;
  const level={healthy:2,degraded:1,danger:0};
  const color={healthy:'#1fbe6b',degraded:'#eea22c',danger:'#e24a5d'};

  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle='#22395d';
  for(let i=0;i<3;i++){const y=p+((h-2*p)/2)*i;ctx.beginPath();ctx.moveTo(p,y);ctx.lineTo(w-p,y);ctx.stroke();}

  if(points.length<2){ctx.fillStyle='#9fb3d8';ctx.fillText('No history for selected range',16,26);requestAnimationFrame(drawChart);return;}

  for(let i=1;i<points.length;i++){
    const a=points[i-1],b=points[i];
    const x0=p+((w-2*p)*(i-1)/(points.length-1));
    const x1=p+((w-2*p)*i/(points.length-1));
    const y0=p+((h-2*p)*(2-(level[a.overall]??1))/2)+Math.sin((x0+phase)/33)*1.4;
    const y1=p+((h-2*p)*(2-(level[b.overall]??1))/2)+Math.sin((x1+phase)/33)*1.4;
    ctx.strokeStyle=color[b.overall]||'#eea22c';
    ctx.lineWidth=2.4;
    ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);ctx.stroke();
  }
  phase+=1.2;
  requestAnimationFrame(drawChart);
}

function renderNodeCards(nodes){
  const root=el('nodeCards');
  root.innerHTML='';
  Object.entries(nodes||{}).forEach(([name,n])=>{
    const dbs=(n.namespace_names||[]).map(x=>`<span class="pill mono">${x}</span>`).join(' ');
    const schemasByDb=n.schemas_by_db||{};
    const tablesByDb=n.table_counts_by_db||{};
    const schemaLines=Object.entries(schemasByDb).map(([db,list])=>`${db}: [${(list||[]).join(', ')}]`).join('\n');
    const tableLines=Object.entries(tablesByDb).map(([db,c])=>`${db}: tables=${c}`).join('\n');
    const cafea=n.cafea_metrics||{};

    const card=document.createElement('article');
    card.className='card';
    card.innerHTML=`
      <div class="node-head">
        <div>
          <div class="node-title mono">${name}</div>
          <div class="node-meta">${n.country||'-'} • mode=${n.mode||'-'} • recovery=${String(!!n.in_recovery)}</div>
        </div>
        <span class="badge ${n.postgresql_active==='active'?'ok':'bad'}"><span class="dot"></span>${(n.postgresql_active||'unknown').toUpperCase()}</span>
      </div>
      <div class="metrics">
        <div class="metric"><div class="mkey">Databases</div><div class="mval mono">${n.database_count??0}</div></div>
        <div class="metric"><div class="mkey">Replication Clients</div><div class="mval mono">${n.replication_clients??0}</div></div>
        <div class="metric"><div class="mkey">Uptime</div><div class="mval mono">${uptime(n.postgres_uptime_sec||0)}</div></div>
      </div>
      <div class="metrics" style="margin-top:8px">
        <div class="metric"><div class="mkey">cafea.users</div><div class="mval mono">${cafea.users??'-'}</div></div>
        <div class="metric"><div class="mkey">cafea.coffee_logs</div><div class="mval mono">${cafea.coffee_logs??'-'}</div></div>
        <div class="metric"><div class="mkey">cafea.stock_settings</div><div class="mval mono">${cafea.stock_settings??'-'}</div></div>
      </div>
      <div style="margin-top:10px" class="row">${dbs||'<span class="mono" style="color:var(--muted)">no namespaces</span>'}</div>
      <div class="mono-box"><strong>Schemas by DB</strong>\n${schemaLines||'-'}\n\n<strong>Tables by DB</strong>\n${tableLines||'-'}</div>
    `;
    root.appendChild(card);
  });
}

function renderNamespaceMismatch(ns){
  const root=el('nsMismatch');
  root.innerHTML='';
  const all=(ns?.all_namespace_names||[]).join(', ');
  el('namespaceUnionCount').textContent=String((ns?.all_namespace_names||[]).length);
  el('namespaceMismatchFlag').textContent=ns?.has_mismatch?'YES':'NO';

  if(!ns?.per_node){
    root.innerHTML='<div class="mismatch-item mono">no namespace data</div>';
    return;
  }

  Object.entries(ns.per_node).forEach(([name,v])=>{
    const item=document.createElement('div');
    item.className='mismatch-item mono';
    item.innerHTML=`<strong>${name}</strong><br/>present: ${(v.present||[]).join(', ')||'-'}<br/>missing: ${(v.missing||[]).join(', ')||'-'}<br/>extra: ${(v.extra||[]).join(', ')||'-'}`;
    root.appendChild(item);
  });

  const union=document.createElement('div');
  union.className='mismatch-item mono';
  union.innerHTML=`<strong>Union</strong><br/>${all||'-'}`;
  root.appendChild(union);
}

function renderContentMismatch(cm){
  const root=el('contentMismatch');
  root.innerHTML='';
  const data=cm?.cafea_metrics_by_node||{};
  const keys=Object.keys(data);
  if(!keys.length){
    root.innerHTML='<div class="mismatch-item mono">No cafea metrics available</div>';
    return;
  }
  keys.forEach(name=>{
    const m=data[name]||{};
    const item=document.createElement('div');
    item.className='mismatch-item mono';
    item.innerHTML=`<strong>${name}</strong><br/>users=${m.users??'-'}<br/>coffee_logs=${m.coffee_logs??'-'}<br/>stock_settings=${m.stock_settings??'-'}`;
    root.appendChild(item);
  });
  const flag=document.createElement('div');
  flag.className='mismatch-item mono';
  flag.innerHTML=`<strong>Mismatch</strong><br/>${cm?.has_mismatch?'YES':'NO'}`;
  root.appendChild(flag);
}

function applyTimeFilter(){
  const range=getRangeSec();
  toTs=nowTs();
  fromTs=toTs-range;

  points=pointsAll.filter(p=>(p.ts||0)>=fromTs && (p.ts||0)<=toTs);

  incidentsAll=incidentsAll.filter(Boolean);
  const filtered=incidentsAll.filter(ev=>{
    const s=Number(ev.start_ts||0), e=Number(ev.end_ts||ev.start_ts||0);
    return s<=toTs && e>=fromTs;
  }).sort((a,b)=>Number(b.start_ts||0)-Number(a.start_ts||0));

  window.__incidentFiltered=filtered;
  renderVirtualIncidents();
}

function renderVirtualIncidents(){
  const sc=el('incidentScroll'), rows=el('incidentRows'), top=el('incidentTopSpacer'), bottom=el('incidentBottomSpacer');
  const data=window.__incidentFiltered||[];
  const total=data.length;

  if(!total){
    top.style.height='0px';bottom.style.height='0px';rows.innerHTML='<div class="incident-row" style="height:auto;color:var(--muted)">No incidents in selected range</div>';
    el('incidentMeta').textContent='0 shown';
    return;
  }

  const viewH=sc.clientHeight||460;
  const start=Math.max(0,Math.floor(sc.scrollTop/rowH)-overscan);
  const count=Math.ceil(viewH/rowH)+overscan*2;
  const end=Math.min(total,start+count);

  top.style.height=(start*rowH)+'px';
  bottom.style.height=((total-end)*rowH)+'px';

  let html='';
  for(let i=start;i<end;i++){
    const ev=data[i];
    const sev=String(ev.severity_last||'degraded').toUpperCase();
    html+=`<article class="incident-row">\
      <div class="incident-head">\
        <strong>${sev}</strong>\
        <span class="mono" style="font-size:11px;color:var(--muted)">${ev.fingerprint||'-'}</span>\
      </div>\
      <div style="margin-top:6px;color:#d3e2ff;font-size:13px">${ev.reason_last||'-'}</div>\
      <div style="margin-top:5px;color:var(--muted);font-size:11px" class="mono">${ev.start_utc||'-'} -> ${ev.end_utc||'OPEN'}</div>\
      <div style="margin-top:4px;color:var(--muted);font-size:11px" class="mono">duration ${uptime(ev.duration_sec||0)} | source ${ev.source_node||'-'}</div>\
    </article>`;
  }
  rows.innerHTML=html;

  const shown=Math.min(10,total);
  el('incidentMeta').textContent=`${shown} initial, ${total} total`;
}

async function refresh(){
  try{
    const [s,h,o]=await Promise.all([getJson(STATUS,CACHE.s),getJson(HISTORY,CACHE.h),getJson(OUTAGES,CACHE.o)]);
    setBadge(s.overall);
    el('primary').textContent=String(s.primary_node||'-');
    el('mode').textContent=String(s.cluster_mode||'-');
    el('backend').textContent=String(s.backend||'postgresql');

    const nodes=s.nodes||{};
    const vals=Object.values(nodes);
    const reachable=vals.filter(n=>n.reachable===true).length;
    el('reach').textContent=`${reachable}/${vals.length||0}`;

    el('updated').textContent=String(s.updated_at_utc||'-');
    el('reason').textContent=String(s.health_reason||'-');

    renderNodeCards(nodes);
    renderNamespaceMismatch(s.namespace_mismatch||{});
    renderContentMismatch(s.content_mismatch||{});

    pointsAll=(h.points||[]).slice(-4000);
    incidentsAll=[];
    if(o.open) incidentsAll.push({...o.open,end_utc:'OPEN',end_ts:nowTs()});
    incidentsAll.push(...(o.events||[]));
    applyTimeFilter();
  }catch(e){
    setBadge('danger');
    el('reason').textContent='status unavailable: '+(e?.message||e);
  }
}

el('refreshBtn').addEventListener('click',refresh);
el('rangeValue').addEventListener('change',applyTimeFilter);
el('rangeUnit').addEventListener('change',applyTimeFilter);
document.querySelectorAll('[data-preset]').forEach(b=>b.addEventListener('click',()=>setPreset(b.dataset.preset)));
el('incidentScroll').addEventListener('scroll',renderVirtualIncidents);

refresh();
drawChart();
setInterval(refresh,10000);
</script>
</body>
</html>
